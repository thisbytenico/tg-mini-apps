import{_ as t,a7 as e,a8 as a,a9 as i,x as s,aa as o,ab as n,g as l,h as r,w as h,i as d,l as c,t as u,j as p,n as f,p as m,ac as g,v as x,y,A as v,C as b,X as w,W as S,T as C,S as T,U as W,V as F,G as N,H as _,k as L,F as P,Y as k,a4 as U,O as I,N as R,K as X,J as H}from"./index-CBLTQg_b.js";import{_ as Y}from"./dw-cell-group.CTMyFgWA.js";import{_ as j}from"./dw-card.CeBHaIwR.js";import{_ as A}from"./u-switch.D7rrzWS4.js";import{_ as M}from"./u-button.D235zKSd.js";import"./u-loading-icon.Bdr6stTV.js";const D=t({name:"",components:{},props:{title:{type:String,default:"请签名"},horizontal:{type:Boolean,default:!0},minSpeed:{type:Number,default:1.5},minWidth:{type:Number,default:3},maxWidth:{type:Number,default:10},openSmooth:{type:Boolean,default:!0},maxHistoryLength:{type:Number,default:20},maxWidthDiffRate:{type:Number,default:20},bgColor:{type:String,default:""}},data:()=>({ctx:null,lineColor:"#333",points:[],historyList:[],canvasWidth:0,canvasHeight:0,canAddHistory:!0}),mounted(){this.ctx=e("signature-pad"),this.$nextTick((()=>{a().select(".signature-pad-body-canvas").boundingClientRect((t=>{this.canvasWidth=t.width,this.canvasHeight=t.height,this.drawBgColor()})).exec()}))},watch:{},computed:{getWarpperClass(){const t=[];return this.horizontal&&t.push("horizontal"),t}},methods:{actionTouchStart(t){this.canAddHistory=!0,this.ctx.setStrokeStyle(this.lineColor),this.ctx.setLineCap("round")},actionTouchMove(t){let e=t.changedTouches[0].x,a=t.changedTouches[0].y;this.initPoint(e,a),this.onDraw()},actionTouchEnd(){this.points=[]},actionClear(){this.drawBgColor()},actionSave(){i({canvasId:"signature-pad",fileType:"png",quality:1,success:t=>{const a=e("signature-pad-copy");var s=this.canvasWidth;a.translate(0,s),a.rotate(-Math.PI/2),a.drawImage(t.tempFilePath,0,0,this.canvasWidth,this.canvasHeight),a.draw(),setTimeout((()=>{i({canvasId:"signature-pad-copy",fileType:"png",quality:1,success:t=>{console.log(t.tempFilePath),this.$emit("on-confirm",t.tempFilePath)}})}),500)}})},initPoint(t,e){var a={x:t,y:e,t:Date.now()},i=this.points.slice(-1)[0];if(!i||i.t!==a.t&&(i.x!==t||i.y!==e)){if(i&&this.openSmooth){var s=this.points.slice(-2,-1)[0];if(a.distance=Math.sqrt(Math.pow(a.x-i.x,2)+Math.pow(a.y-i.y,2)),a.speed=a.distance/(a.t-i.t||.1),a.lineWidth=this.getLineWidth(a.speed),s&&s.lineWidth&&i.lineWidth){var o=(a.lineWidth-i.lineWidth)/i.lineWidth,n=this.maxWidthDiffRate/100;if(n=n>1?1:n<.01?.01:n,Math.abs(o)>n){var l=o>0?n:-n;a.lineWidth=i.lineWidth*(1+l)}}}this.points.push(a),this.points=this.points.slice(-3)}},getLineWidth(t){var e=this.minSpeed>10?10:this.minSpeed<1?1:this.minSpeed,a=(this.maxWidth-this.minWidth)*t/e,i=Math.max(this.maxWidth-a,this.minWidth);return Math.min(i,this.maxWidth)},onDraw(){if(this.points.length<2)return;this.addHistory();var t=this.points.slice(-1)[0],e=this.points.slice(-2,-1)[0];let a=this;var i=function(){a.openSmooth?a.drawSmoothLine(e,t):a.drawNoSmoothLine(e,t)};"function"==typeof this.requestAnimationFrame?this.requestAnimationFrame((function(){return i()})):i()},addHistory(){if(!this.maxHistoryLength||!this.canAddHistory)return;if(this.canAddHistory=!1,!this.getImagePath)return void this.historyList.length++;let t=this;t.getImagePath().then((function(e){e&&(t.historyList.push(e),t.historyList=t.historyList.slice(-t.maxHistoryLength))}))},drawSmoothLine(t,e){var a=e.x-t.x,i=e.y-t.y;if(Math.abs(a)+Math.abs(i)<=2?(e.lastX1=e.lastX2=t.x+.5*a,e.lastY1=e.lastY2=t.y+.5*i):(e.lastX1=t.x+.3*a,e.lastY1=t.y+.3*i,e.lastX2=t.x+.7*a,e.lastY2=t.y+.7*i),e.perLineWidth=(t.lineWidth+e.lineWidth)/2,"number"==typeof t.lastX1){if(this.drawCurveLine(t.lastX2,t.lastY2,t.x,t.y,e.lastX1,e.lastY1,e.perLineWidth),t.isFirstPoint)return;if(t.lastX1===t.lastX2&&t.lastY1===t.lastY2)return;var s=this.getRadianData(t.lastX1,t.lastY1,t.lastX2,t.lastY2),o=this.getRadianPoints(s,t.lastX1,t.lastY1,t.perLineWidth/2),n=this.getRadianPoints(s,t.lastX2,t.lastY2,e.perLineWidth/2);this.drawTrapezoid(o[0],n[0],n[1],o[1])}else e.isFirstPoint=!0},drawNoSmoothLine(t,e){e.lastX=t.x+.5*(e.x-t.x),e.lastY=t.y+.5*(e.y-t.y),"number"==typeof t.lastX&&this.drawCurveLine(t.lastX,t.lastY,t.x,t.y,e.lastX,e.lastY,this.maxWidth)},drawCurveLine(t,e,a,i,s,o,n){n=Number(n.toFixed(1)),this.ctx.setLineWidth&&this.ctx.setLineWidth(n),this.ctx.lineWidth=n,this.ctx.beginPath(),this.ctx.moveTo(Number(t.toFixed(1)),Number(e.toFixed(1))),this.ctx.quadraticCurveTo(Number(a.toFixed(1)),Number(i.toFixed(1)),Number(s.toFixed(1)),Number(o.toFixed(1))),this.ctx.stroke(),this.ctx.draw&&this.ctx.draw(!0)},drawTrapezoid(t,e,a,i){this.ctx.beginPath(),this.ctx.moveTo(Number(t.x.toFixed(1)),Number(t.y.toFixed(1))),this.ctx.lineTo(Number(e.x.toFixed(1)),Number(e.y.toFixed(1))),this.ctx.lineTo(Number(a.x.toFixed(1)),Number(a.y.toFixed(1))),this.ctx.lineTo(Number(i.x.toFixed(1)),Number(i.y.toFixed(1))),this.ctx.setFillStyle&&this.ctx.setFillStyle(this.lineColor),this.ctx.fillStyle=this.lineColor,this.ctx.fill(),this.ctx.draw&&this.ctx.draw(!0)},getRadianData(t,e,a,i){var s=a-t,o=i-e;if(0===s)return{val:0,pos:-1};if(0===o)return{val:0,pos:1};var n=Math.abs(Math.atan(o/s));return a>t&&i<e||a<t&&i>e?{val:n,pos:1}:{val:n,pos:-1}},getRadianPoints(t,e,a,i){if(0===t.val)return 1===t.pos?[{x:e,y:a+i},{x:e,y:a-i}]:[{y:a,x:e+i},{y:a,x:e-i}];var s=Math.sin(t.val)*i,o=Math.cos(t.val)*i;return 1===t.pos?[{x:e+s,y:a+o},{x:e-s,y:a-o}]:[{x:e+s,y:a-o},{x:e-s,y:a+o}]},drawBgColor(){this.bgColor?(this.ctx.setFillStyle&&this.ctx.setFillStyle(this.bgColor),this.ctx.fillStyle=this.bgColor,this.ctx.fillRect(0,0,this.canvasWidth,this.canvasHeight)):this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.ctx.draw&&this.ctx.draw(!0)},drawByImage(t){this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight);try{this.ctx.drawImage(t,0,0,this.canvasWidth,this.canvasHeight),this.ctx.draw&&this.ctx.draw(!0)}catch(e){this.historyList.length=0}},undo(){if(this.getImagePath&&this.historyList.length){var t=this.historyList.splice(-1)[0];this.drawByImage(t),0===this.historyList.length&&this.clear()}},isEmpty(){return 0===this.historyList.length},selectColorEvent(t,e){this.selectColor=t,this.lineColor=e,this.ctx.setStrokeStyle(this.lineColor)},subCanvas(){this.isEmpty()?s({title:"没有任何绘制内容哦",icon:"none"}):i({canvasId:"handWriting",fileType:"png",quality:1,success(t){s({title:"以保存"}),o({filePath:t.tempFilePath,success(t){s({title:"已成功保存到相册",duration:2e3})}})}})},saveCanvasAsImg(){i({canvasId:"handWriting",fileType:"png",quality:1,success(t){o({filePath:t.tempFilePath,success(t){s({title:"已保存到相册",duration:2e3})}})}})},previewCanvasImg(){i({canvasId:"handWriting",fileType:"jpg",quality:1,success(t){n({urls:[t.tempFilePath]})}})},ajaxXxx(){}}},[["render",function(t,e,a,i,s,o){const n=m,x=g;return l(),r(n,{class:f(["signature-pad",o.getWarpperClass])},{default:h((()=>[d(n,{class:"signature-pad-header"},{default:h((()=>[d(n,{class:"signature-pad-header-title"},{default:h((()=>[c(u(a.title),1)])),_:1})])),_:1}),d(n,{class:"signature-pad-body"},{default:h((()=>[d(x,{class:"signature-pad-body-canvas","disable-scroll":!0,onTouchstart:o.actionTouchStart,onTouchmove:o.actionTouchMove,onTouchend:o.actionTouchEnd,"canvas-id":"signature-pad"},null,8,["onTouchstart","onTouchmove","onTouchend"])])),_:1}),d(n,{class:"signature-pad-footer"},{default:h((()=>[d(n,{class:"signature-pad-footer-btn",onClick:o.actionClear},{default:h((()=>[c("清除")])),_:1},8,["onClick"]),d(n,{class:"signature-pad-footer-btn",onClick:o.actionSave},{default:h((()=>[c("保存")])),_:1},8,["onClick"])])),_:1}),d(x,{class:"signature-pad-copycanvas","canvas-id":"signature-pad-copy",style:p(`width:${s.canvasHeight}px;height:${s.canvasWidth}px;`)},null,8,["style"])])),_:1},8,["class"])}],["__scopeId","data-v-861adf3d"]]);const B=t({name:"",components:{},data:()=>({config:x,isShowPopup:!1,isDefault:!0,imgUrl:"",form:{signatureUrl:"",staffName:"",phone:"",defaultStatus:!1}}),onLoad(t){const{type:e,info:a}=t;try{let t=JSON.parse(decodeURIComponent(a));this.form.phone=t.PHONE,this.form.staffName=t.STAFF_NAME,this.form.signatureUrl=t.SIGNATURE_URL,this.form.id=t.ID,"Y"==t.DEFAULT_STATUS?this.form.defaultStatus=!0:this.form.defaultStatus=!1}catch(i){}this.type=e,"add"==this.type&&(this.form.defaultStatus=!0),this.initPage()},watch:{},computed:{},methods:{async actionSubmit(){if(!this.form.phone)return void s({icon:"none",title:"请输入手机号",duration:2e3});if(11!==this.form.phone.length)return void s({icon:"none",title:"请输入正确的手机号",duration:2e3});if(console.log(this.form.staffName.length),this.form.staffName.length<2||this.form.staffName.length>=10)return void s({icon:"none",title:"请输入正确的姓名",duration:2e3});if(!/^[\u4e00-\u9fa5]+$/.test(this.form.staffName))return void s({icon:"none",title:"请输入正确的姓名",duration:2e3});let t={...this.form};t.defaultStatus?t.defaultStatus="Y":t.defaultStatus="N",t.signatureUrl?"添加员工"==this.pageTitle?y.post("sofn-tts-web-branch/ttsScltxxcjStaff/addTtsScltxxcjStaff?id="+v("userInfo").id,{...t},{header:{token:v("token")},toast:!1}).then((t=>{b("添加成功"),w({delta:1}),S("employeeRefresh")})):y.post("sofn-tts-web-branch/ttsScltxxcjStaff/updateTtsScltxxcjStaff?id="+v("userInfo").id,{...t},{header:{token:v("token")},toast:!1}).then((t=>{b("修改成功"),w({delta:1}),S("employeeRefresh")})):s({icon:"none",title:"请先签名",duration:2e3})},base64ToFile(t,e){const a=t.split(";base64,"),i=a[0].split(":")[1],s=window.atob(a[1]),o=s.length,n=new Uint8Array(o);for(let h=0;h<o;++h)n[h]=s.charCodeAt(h);const l=new Blob([n],{type:i}),r=URL.createObjectURL(l);console.log(r);return new File([l],e,{type:i})},getTempPath:t=>URL.createObjectURL(t),actionShowPopup(){this.isShowPopup=!0},actionSignConfirm(t){C({title:"正在上传中请稍等",mask:!0});let e=this.base64ToFile(t,"image.png");console.log(e),T({url:x.baseUrl+"/sofn-tts-web-branch/ttsScltxxcjRegiter/upload?fileapi17268223914946",file:e,header:{},formData:{_file:"image.png"},success:t=>{let e=JSON.parse(t.data);this.form.signatureUrl=e.path,this.isShowPopup=!1},complete:t=>{W()}})},initPage(){switch(this.type){case"add":this.pageTitle="添加员工";break;case"edit":this.pageTitle="修改员工"}F({title:this.pageTitle})},ajaxXxx(){}}},[["render",function(t,e,a,i,s,o){const n=N(_("u-navbar"),k),u=X,p=N(_("dw-cell"),U),f=N(_("dw-cell-group"),Y),g=m,x=H,y=N(_("dw-card"),j),v=N(_("u-switch"),A),b=N(_("u-button"),M),w=N(_("dw-icon"),I),S=N(_("dw-signature-pad"),D),C=N(_("u-popup"),R);return l(),L(P,null,[d(g,{class:"employee-edit"},{default:h((()=>[d(n,{title:t.pageTitle,autoBack:!0,placeholder:"",border:""},null,8,["title"]),d(g,{class:"employee-edit-body"},{default:h((()=>[d(f,null,{default:h((()=>[d(p,null,{default:h((()=>[d(u,{modelValue:s.form.staffName,"onUpdate:modelValue":e[0]||(e[0]=t=>s.form.staffName=t),type:"text",placeholder:"请输入姓名"},null,8,["modelValue"])])),_:1}),d(p,null,{default:h((()=>[d(u,{modelValue:s.form.phone,"onUpdate:modelValue":e[1]||(e[1]=t=>s.form.phone=t),type:"text",placeholder:"请输入手机号"},null,8,["modelValue"])])),_:1})])),_:1}),d(g,{class:"mt12"}),d(y,{shape:"none"},{default:h((()=>[d(g,{onClick:o.actionShowPopup,class:"employee-edit-signpad"},{default:h((()=>[s.form.signatureUrl?(l(),r(x,{key:0,mode:"aspectFit",src:s.config.baseUrl+"/sofn-sys-web/sysTemplate/downPic?fileUrl="+s.form.signatureUrl,style:{width:"100%",height:"128rpx"}},null,8,["src"])):(l(),r(g,{key:1,class:"employee-edit-signpad-empty"},{default:h((()=>[d(g,null,{default:h((()=>[c("点击这里")])),_:1}),d(g,{class:"text-desc"},{default:h((()=>[c("您可以在线录入签名信息")])),_:1})])),_:1}))])),_:1},8,["onClick"])])),_:1}),d(f,{class:"mt12"},{default:h((()=>[d(p,null,{extra:h((()=>[d(v,{modelValue:s.form.defaultStatus,"onUpdate:modelValue":e[2]||(e[2]=t=>s.form.defaultStatus=t),activeColor:"#08CA8A"},null,8,["modelValue"])])),default:h((()=>[d(g,null,{default:h((()=>[c("是否设为默认")])),_:1})])),_:1})])),_:1}),d(g,{class:"mt12 pl12 pr12"},{default:h((()=>[d(b,{style:{background:"#00B568",color:"#FFF"},onClick:o.actionSubmit},{default:h((()=>[c("保存")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1}),d(C,{show:s.isShowPopup},{default:h((()=>[d(g,{style:{height:"100vh",position:"relative"}},{default:h((()=>[d(w,{onClick:e[3]||(e[3]=t=>s.isShowPopup=!1),name:"close",class:"employee-edit-close",size:"36rpx",color:"#666"}),d(S,{ref:"signaturePad",minWidth:"6",maxWidth:"15",onOnConfirm:o.actionSignConfirm},null,8,["onOnConfirm"])])),_:1})])),_:1},8,["show"])],64)}],["__scopeId","data-v-528ac5f6"]]);export{B as default};
